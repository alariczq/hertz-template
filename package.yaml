layouts:
  - path: handler.go
    disable: true
  - path: register.go
    disable: true

  - path: "router.go"
    update_behavior:
      type: cover
    body: |-
      // Code generated by hz. DO NOT EDIT.

      package {{$.PackageName}}

      import (
          "github.com/cloudwego/hertz/pkg/app/server"
          {{- range $k, $v := .HandlerPackages}}

          "{{trimSuffix (printf "/%s" $k) $v}}"
          {{- end}}
      )

      {{define "g"}}
      {{- if eq .Path "/"}}r
      {{- else}}{{.GroupName}}{{end}}
      {{- end}}

      {{define "G"}}
      {{- if ne .Handler ""}}
          {{- .GroupName}}.{{.HttpMethod}}("{{.Path}}", append({{.HandlerMiddleware}}Mw(), h.{{trimPrefix (printf "%s." .HandlerPackageAlias) .Handler}})...)
      {{- end}}
      {{- if ne (len .Children) 0}}
      {{.MiddleWare}} := {{template "g" .}}.Group("{{.Path}}", {{.GroupMiddleware}}Mw()...)
      {{- end}}
      {{- range $_, $router := .Children}}
      {{- if ne .Handler ""}}
          {{template "G" $router}}
      {{- else}}
          {   {{template "G" $router}}
          }
      {{- end}}
      {{- end}}
      {{- end}}

      func Register(r *server.Hertz, h *handler.{{range $k, $v := .HandlerPackages}}{{title $k}}{{end}}Handler) {
      {{- template "G" .Router}}
      }

  - path: "{{.HandlerDir}}/{{.GenPackage}}.go"
    loop_service: true
    update_behavior:
      type: skip
    body: |-
      {{- $pkg := .IDLPackageInfo.GenPackage}}
      {{- $Pkg := title $pkg}}
      {{- $mod := .IDLPackageInfo.GoModule}}
      {{- $modelDir := .IDLPackageInfo.ModelDir}}

      package handler

      import (
          "context"

          "github.com/cloudwego/hertz/pkg/app"

          "{{$mod}}/{{$modelDir}}/{{$pkg}}"
          "{{$mod}}/pkg/handler"
      )

      type {{$Pkg}}Handler struct {
          resp handler.Responder
          svc  {{$pkg}}.{{$Pkg}}Service
      }

      func New{{$Pkg}}Handler(resp handler.Responder, svc {{$pkg}}.{{$Pkg}}Service) *{{$Pkg}}Handler {
          return &{{$Pkg}}Handler{resp: resp, svc: svc}
      }
      {{range .Methods}}
      func (h *{{$Pkg}}Handler) {{.Name}}(ctx context.Context, c *app.RequestContext) {
          var req {{$pkg}}.{{.RequestTypeRawName}}
          if err := c.BindAndValidate(&req); err != nil {
              h.resp.Fail(c, err)
              return
          }

          resp, err := h.svc.{{.Name}}(ctx, &req)
          if err != nil {
              h.resp.Fail(c, err)
              return
          }

          h.resp.Success(c, resp)
      }
      {{end}}

  - path: "{{.ModelDir}}/{{.GenPackage}}/service.go"
    loop_service: true
    update_behavior:
      type: cover
    body: |-
      // Code generated by hz. DO NOT EDIT.

      package {{.FilePackage}}

      import "context"

      type {{title .FilePackage}}Service interface {
          {{- range .Methods}}
          {{.Name}}(ctx context.Context, req *{{.RequestTypeRawName}}) (*{{.ReturnTypeRawName}}, error)
          {{- end}}
      }

  - path: "internal/service/{{.GenPackage}}/service.go"
    loop_service: true
    update_behavior:
      type: skip
    body: |-
      {{- $pkg := .FilePackage}}
      {{- $Pkg := title $pkg}}
      package {{$pkg}}

      import "{{.IDLPackageInfo.GoModule}}/{{.IDLPackageInfo.ModelDir}}/{{$pkg}}"

      type {{$Pkg}}Service struct {}

      func NewService() {{$pkg}}.{{$Pkg}}Service {
          return &{{$Pkg}}Service{}
      }

  - path: "internal/service/{{.GenPackage}}/{{ToSnakeCase .MethodName}}.impl.go"
    loop_method: true
    update_behavior:
      type: skip
    body: |-
      {{- $pkg := .FilePackage}}
      {{- $Pkg := title $pkg}}
      package {{$pkg}}

      import (
          "context"
          "errors"

          "{{.IDLPackageInfo.GoModule}}/{{.IDLPackageInfo.ModelDir}}/{{$pkg}}"
      )

      func (s *{{$Pkg}}Service) {{.Name}}(ctx context.Context, req *{{$pkg}}.{{.RequestTypeRawName}}) (*{{$pkg}}.{{.ReturnTypeRawName}}, error) {
          return nil, errors.New("not implemented")
      }

  - path: "biz/module/registry.go"
    update_behavior:
      type: skip
    body: |-
      package module

      import "go.uber.org/fx"

      var modules []fx.Option

      func register(opt fx.Option) {
          modules = append(modules, opt)
      }

      func Modules() fx.Option {
          return fx.Options(modules...)
      }

  - path: "biz/module/{{.GenPackage}}.go"
    loop_service: true
    update_behavior:
      type: cover
    body: |-
      // Code generated by hz. DO NOT EDIT.
      {{- $pkg := .IDLPackageInfo.GenPackage}}
      {{- $Pkg := title $pkg}}
      {{- $mod := .IDLPackageInfo.GoModule}}

      package module

      import (
          "go.uber.org/fx"

          "{{$mod}}/{{.IDLPackageInfo.HandlerDir}}"
          {{$pkg}}router "{{$mod}}/{{.IDLPackageInfo.RouterDir}}/{{$pkg}}"
          {{$pkg}}service "{{$mod}}/internal/service/{{$pkg}}"
      )

      func init() {
          register(fx.Module("{{$pkg}}",
              fx.Provide({{$pkg}}service.NewService, handler.New{{$Pkg}}Handler),
              fx.Invoke({{$pkg}}router.Register),
          ))
      }

  - path: "pkg/handler/handler.go"
    update_behavior:
      type: skip
    body: |-
      package handler

      import (
        "github.com/cloudwego/hertz/pkg/app"
        "github.com/cloudwego/hertz/pkg/protocol/consts"
      )

      type Responder interface {
        Success(c *app.RequestContext, resp any)
        Fail(c *app.RequestContext, err error)
      }

      type DefaultResponder struct{}

      func Default() Responder {
        return DefaultResponder{}
      }

      func (r DefaultResponder) Success(c *app.RequestContext, resp any) {
        c.JSON(consts.StatusOK, resp)
      }

      func (r DefaultResponder) Fail(c *app.RequestContext, err error) {
        c.JSON(consts.StatusInternalServerError, err.Error())
      }
