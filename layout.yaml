layouts:
  - path: .hz
    delims:
      - "{{"
      - "}}"
    body: |-
      // Code generated by hz. DO NOT EDIT.
      hz version: {{.hzVersion}}

  - path: .gitignore
    delims:
      - ""
      - ""
    body: |-
      *.o
      *.a
      *.so
      _obj
      _test
      *.[568vq]
      [568vq].out
      *.cgo1.go
      *.cgo2.c
      _cgo_defun.c
      _cgo_gotypes.go
      _cgo_export.*
      _testmain.go
      *.exe
      *.exe~
      *.test
      *.prof
      *.rar
      *.zip
      *.gz
      *.log
      .DS_Store
      /.idea
      /.vscode
      /output
      /bin
      *.local.yml

  - path: go.mod
    delims:
      - "{{"
      - "}}"
    body: |-
      module {{.GoModule}}

      go 1.21

      require (
      	github.com/cloudwego/hertz v0.10.4
      	github.com/hertz-contrib/cors v0.1.0
      	github.com/hertz-contrib/logger/accesslog v0.0.0-20241107070745-e4ce8c54dd97
      	github.com/hertz-contrib/requestid v1.1.0
      	go.uber.org/fx v1.23.0
      )

  - path: Makefile
    delims:
      - "{{"
      - "}}"
    body: |-
      .PHONY: build run clean tidy hz

      build:
      	go build -o bin/{{.ServiceName}} ./cmd/server

      run:
      	go run ./cmd/server

      clean:
      	rm -rf bin/

      tidy:
      	go mod tidy

      hz:
      	hz update -idl idl/api.proto

  - path: cmd/server/main.go
    delims:
      - "{{"
      - "}}"
    body: |-
      package main

      import (
      	"context"
      	"os"

      	"go.uber.org/fx"

      	"{{.GoModule}}/biz/router"
      	"{{.GoModule}}/internal/server"
      	"{{.GoModule}}/pkg/handler"
      )

      func main() {
      	addr := os.Getenv("ADDR")
      	if addr == "" {
      		addr = ":8080"
      	}

      	fx.New(
      		fx.Supply(addr),
      		fx.Provide(
      			server.NewHertzServer,
      			handler.Default,
      		),
      		router.Options(),
      		fx.Invoke(func(lc fx.Lifecycle, s *server.HertzServer) {
      			lc.Append(fx.Hook{
      				OnStart: func(ctx context.Context) error { return s.Start(ctx) },
      				OnStop:  func(ctx context.Context) error { return s.Stop(ctx) },
      			})
      		}),
      	).Run()
      }

  - path: internal/server/hertz.go
    delims:
      - "{{"
      - "}}"
    body: |-
      package server

      import (
      	"context"
      	"time"

      	"github.com/cloudwego/hertz/pkg/app"
      	"github.com/cloudwego/hertz/pkg/app/server"
      	"github.com/cloudwego/hertz/pkg/common/hlog"
      	"github.com/cloudwego/hertz/pkg/protocol/consts"
      	"github.com/hertz-contrib/cors"
      	"github.com/hertz-contrib/logger/accesslog"
      	"github.com/hertz-contrib/requestid"
      	"go.uber.org/fx"
      )

      type HertzServer struct {
      	*server.Hertz
      	addr string
      }

      func (s *HertzServer) Start(ctx context.Context) error {
      	hlog.Infof("hertz server starting on %s", s.addr)
      	go s.Hertz.Run()
      	return nil
      }

      func (s *HertzServer) Stop(ctx context.Context) error {
      	hlog.Info("hertz server stopping...")
      	return s.Hertz.Shutdown(ctx)
      }

      type HertzServerResult struct {
      	fx.Out
      	Server     *HertzServer
      	HertzInner *server.Hertz
      }

      func NewHertzServer(addr string) (HertzServerResult, error) {
      	h := server.Default(
      		server.WithHostPorts(addr),
      		server.WithReadTimeout(30*time.Second),
      		server.WithWriteTimeout(30*time.Second),
      		server.WithExitWaitTime(5*time.Second),
      	)

      	h.Use(
      		requestid.New(),
      		cors.New(cors.Config{
      			AllowAllOrigins:  true,
      			AllowMethods:     []string{"GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"},
      			AllowHeaders:     []string{"Origin", "Content-Type", "Accept", "Authorization", "X-Request-ID"},
      			ExposeHeaders:    []string{"Content-Length", "X-Request-ID"},
      			AllowCredentials: true,
      			MaxAge:           86400,
      		}),
      		accesslog.New(),
      	)

      	h.GET("/healthz", func(ctx context.Context, c *app.RequestContext) {
      		c.JSON(consts.StatusOK, map[string]string{"status": "ok"})
      	})
      	h.GET("/readyz", func(ctx context.Context, c *app.RequestContext) {
      		c.JSON(consts.StatusOK, map[string]string{"status": "ok"})
      	})

      	return HertzServerResult{
      		Server:     &HertzServer{Hertz: h, addr: addr},
      		HertzInner: h,
      	}, nil
      }

  - path: pkg/errors/errors.go
    delims:
      - ""
      - ""
    body: |-
      package errors

      type BizError struct {
      	Status  int
      	Code    int
      	Message string
      	Data    any
      }

      func (e *BizError) Error() string {
      	return e.Message
      }

      func (e *BizError) WithData(data any) *BizError {
      	e.Data = data
      	return e
      }

      func New(status, code int, message string) *BizError {
      	return &BizError{Status: status, Code: code, Message: message}
      }

      func BadRequest(message string) *BizError {
      	return &BizError{Status: 400, Code: 400, Message: message}
      }

      func Unauthorized(message string) *BizError {
      	return &BizError{Status: 401, Code: 401, Message: message}
      }

      func NotFound(message string) *BizError {
      	return &BizError{Status: 404, Code: 404, Message: message}
      }

      func Internal(message string) *BizError {
      	return &BizError{Status: 500, Code: 500, Message: message}
      }

  - path: biz/handler/
    delims:
      - ""
      - ""
    body: ""

  - path: biz/model/
    delims:
      - ""
      - ""
    body: ""

  - path: biz/router/
    delims:
      - ""
      - ""
    body: ""

  - path: biz/service/
    delims:
      - ""
      - ""
    body: ""

  - path: idl/hertz/api.proto
    delims:
      - ""
      - ""
    body: |-
      syntax = "proto2";
      package api;
      option go_package = "api";
      import "google/protobuf/descriptor.proto";

      extend google.protobuf.FieldOptions {
        optional string raw_body = 50101;
        optional string query = 50102;
        optional string header = 50103;
        optional string cookie = 50104;
        optional string body = 50105;
        optional string path = 50106;
        optional string vd = 50107;
        optional string form = 50108;
        optional string js_conv = 50109;
        optional string file_name = 50110;
        optional string none = 50111;
        optional string form_compatible = 50131;
        optional string js_conv_compatible = 50132;
        optional string file_name_compatible = 50133;
        optional string none_compatible = 50134;
        optional string go_tag = 51001;
      }

      extend google.protobuf.MethodOptions {
        optional string get = 50201;
        optional string post = 50202;
        optional string put = 50203;
        optional string delete = 50204;
        optional string patch = 50205;
        optional string options = 50206;
        optional string head = 50207;
        optional string any = 50208;
        optional string gen_path = 50301;
        optional string api_version = 50302;
        optional string tag = 50303;
        optional string name = 50304;
        optional string api_level = 50305;
        optional string serializer = 50306;
        optional string param = 50307;
        optional string baseurl = 50308;
        optional string handler_path = 50309;
        optional string handler_path_compatible = 50331;
      }

      extend google.protobuf.EnumValueOptions {
        optional int32 http_code = 50401;
      }

      extend google.protobuf.ServiceOptions {
        optional string base_domain = 50402;
        optional string base_domain_compatible = 50731;
        optional string service_path = 50732;
      }

      extend google.protobuf.MessageOptions {
        optional string reserve = 50830;
      }

  - path: idl/ping.proto
    delims:
      - ""
      - ""
    body: |-
      syntax = "proto3";

      package ping;

      option go_package = "ping";

      import "hertz/api.proto";

      message PingRequest {}

      message PingResponse {
        string message = 1;
      }

      service PingService {
        rpc Ping(PingRequest) returns (PingResponse) {
          option (api.get) = "/api/v1/ping";
        }
      }

  - path: biz/service/ping/service.go
    delims:
      - ""
      - ""
    body: |-
      package ping

      import "{{.GoModule}}/biz/model/ping"

      type PingService struct {}

      func NewService() ping.PingService {
        return &PingService{}
      }

  - path: biz/service/ping/ping.impl.go
    delims:
      - ""
      - ""
    body: |-
      package ping

      import (
        "context"
        "{{.GoModule}}/biz/model/ping"
      )

      func (s *PingService) Ping(ctx context.Context, req *ping.PingRequest) (*ping.PingResponse, error) {
        return &ping.PingResponse{Message: "pong"}, nil
      }
